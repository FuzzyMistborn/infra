steps:
  - name: ansible-lint and yamllint
    image: fuzzymistborn/docker-linting:latest
    environment:
      ansible_vault_password:
        from_secret: ansible_vault_password
    commands:
      - ansible-galaxy role install -r requirements.yaml
      - ansible-galaxy collection install -r requirements.yaml
      - sed -i '8d' ansible.cfg
      - echo $ansible_vault_password > .vault-password
      - ansible-lint --strict .
      - yamllint -s .
      - find . -maxdepth 1 -name '*.yml' | grep -v '.woodpecker.yml' | grep -v 'FUNDING.yml' | xargs ansible-playbook --syntax-check --list-tasks --vault-password-file .vault-password
    when:
      - event: push

  - name: Notify Success
    image: appleboy/drone-telegram
    settings:
      token:
        from_secret: tg_token
      to:
        from_secret: tg_id
      format: markdown
      message: "âœ…  Build for `${CI_REPO_NAME}` was *successful*!\nğŸŒ  [Output](${CI_PIPELINE_URL})\nğŸ‘¤ Author: ${CI_COMMIT_AUTHOR}\nğŸ“  Commit: ${CI_COMMIT_MESSAGE}"
    when:
      - event: push
        status: [success]

  - name: Notify Failure
    image: appleboy/drone-telegram
    settings:
      token:
        from_secret: tg_token
      to:
        from_secret: tg_id
      format: markdown
      message: "âŒ  Build for `${CI_REPO_NAME}` has *FAILED*!\nğŸŒ  [Output](${CI_PIPELINE_URL})\nğŸ‘¤ Author: ${CI_COMMIT_AUTHOR}\nğŸ“  Commit: ${CI_COMMIT_MESSAGE}"
    when:
      - event: push
        status: [failure]