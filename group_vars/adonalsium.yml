---
adonalsium_ip: 192.168.30.10
hostname: adonalsium

### Install packages with grog.package
package_list:
  - name: pve-headers
  - name: git
  - name: nut
  - name: fail2ban
  - name: ifupdown2
  - name: restic
  - name: rsyslog
  - name: wireguard

### Disks
mergerfs_mount:
  - path: /mnt/Media

parity_disks:
  - path: /mnt/parity1
    source: /dev/disk/by-id/ata-ST8000NM0055-1RM112_ZA11KJXC-part1
    fs: ext4
    opts: defaults
    content: false

data_disks:
  - path: /mnt/disk1
    source: /dev/disk/by-id/ata-ST8000NM0055-1RM112_ZA11KKDB-part1
    fs: ext4
    opts: defaults
    content: true
  - path: /mnt/disk2
    source: /dev/disk/by-id/ata-ST8000NM0055-1RM112_ZA11KW0F-part1
    fs: ext4
    opts: defaults
    content: true
  - path: /mnt/disk3
    source: /dev/disk/by-id/ata-ST8000NM0055-1RM112_ZA11KW4B-part1
    fs: ext4
    opts: defaults
    content: true
  - path: /mnt/disk4
    source: /dev/disk/by-id/ata-ST4000NM0024-1HT178_Z4F06WRN-part1
    fs: ext4
    opts: defaults
    content: true
  - path: /mnt/disk5
    source: /dev/disk/by-id/ata-WDC_WD60EFRX-68MYMN1_WD-WX21D25R5VX9-part1
    fs: ext4
    opts: defaults
    content: true
  - path: /mnt/disk6
    source: /dev/disk/by-id/ata-WDC_WD60EFRX-68MYMN1_WD-WX31D25040NC-part1
    fs: ext4
    opts: defaults
    content: true

fstab_mergerfs:
  - source: "/mnt/disk*"
    mountpoint: "/mnt/Media"
    fs: fuse.mergerfs
    opts: "direct_io,defaults,allow_other,minfreespace=50G,fsname=mergerfs"

nfs_mount:
  - path: /mnt/synology_backup
    source: 192.168.30.25:/volume1/Backup/
    fs: nfs
    opts: defaults
    content: false
  - path: /mnt/synology_minio
    source: 192.168.30.25:/volume1/Minio/
    fs: nfs
    opts: defaults
    content: false

### Syncthing/Retroarch
retroarch_roms_dir: /mnt/Media/Files/Roms/RetroArch-ROMs
retroarch_config_dir: /mnt/Media/Files/Roms/RetroArch

syncthing_api_key: "{{secret_syncthing_api_adonalsium}}"
syncthing_gui_authentication: true
syncthing_gui_user: "{{main_username}}"
syncthing_gui_pass: "{{secret_syncthing_gui_pass}}"

syncthing_folders:
  - id: "{{secret_syncthing_sys_folder_id}}"
    label: "RetroArch - System"
    path: "{{retroarch_config_dir}}"
    type: "sendreceive" # options are 'sendreceive' 'sendonly' and 'receiveonly'
    rescanInterval: 600 # time in seconds
    devices:
      - "{{secret_syncthing_kelsier_device}}"
      - "{{secret_syncthing_retroarchpi_device}}"
      - "{{secret_syncthing_steamdeck_device}}"
  - id: "{{secret_syncthing_rom_folder_id}}"
    label: "RetroArch - ROMs"
    path: "{{retroarch_roms_dir}}"
    type: "sendonly" # options are 'sendreceive' 'sendonly' and 'receiveonly'
    rescanInterval: 600 # time in seconds
    devices:
      - "{{secret_syncthing_kelsier_device}}"
      - "{{secret_syncthing_retroarchpi_device}}"
      - "{{secret_syncthing_steamdeck_device}}"

syncthing_devices:
 - id: "{{secret_syncthing_retroarchpi_device}}"
   name: RetroArch Pi
   address: tcp://192.168.30.26:22000
 - id: "{{secret_syncthing_kelsier_device}}"
   name: Kelsier
   address: tcp://192.168.10.10:22000
 - id: "{{secret_syncthing_steamdeck_device}}"
   name: SteamDeck
   address: tcp://192.168.10.X:22000

### Infrastructure
lxc:
  - name: Dominion
    vmid: 200
    privileged: true
    gw: 192.168.10.1
    ip: 192.168.10.15
    bridge: vmbr3
    disk: 'local-lvm:10'
    cores: 2
    memory: 512
  - name: Honor
    vmid: 201
    privileged: true
    gw: 192.168.50.1
    ip: 192.168.50.10
    bridge: vmbr2
    disk: 'local-lvm:15'
    cores: 2
    memory: 1024
    nesting: 1
    keyctl: 1
  - name: Valor
    vmid: 202
    privileged: true
    gw: 192.168.50.1
    ip: 192.168.50.11
    bridge: vmbr2
    disk: 'local-lvm:10'
    cores: 2
    memory: 512
    nesting: 1
    keyctl: 1
  - name: Mercy
    vmid: 203
    privileged: true
    gw: 192.168.50.1
    ip: 192.168.50.30
    bridge: vmbr2
    disk: 'local-lvm:10'
    cores: 1
    memory: 512
    template: local:vztmpl/ubuntu-18.04-standard_18.04.1-1_amd64.tar.gz
  - name: Omada
    vmid: 204
    privileged: true
    gw: 192.168.1.1
    ip: 192.168.1.10
    bridge: vmbr0
    disk: 'local-lvm:10'
    cores: 2
    memory: 1024
    nesting: 1
    keyctl: 1
  - name: Elasticsearch
    vmid: 205
    privileged: true
    gw: 192.168.30.1
    ip: 192.168.30.16
    disk: 'local-lvm:30'
    cores: 2
    memory: 2048
  - name: Autonomy
    vmid: 251
    privileged: false
    gw: 192.168.30.1
    ip: 192.168.30.12
    disk: 'local-lvm510'
    cores: 12
    memory: 5120
    nesting: 1
    keyctl: 1
  - name: Cultivation
    vmid: 252
    privileged: true
    gw: 192.168.50.1
    ip: 192.168.50.21
    bridge: vmbr2
    disk: 'local-lvm:40'
    cores: 4
    memory: 2048
    nesting: 1
    keyctl: 1
  - name: Preservation
    vmid: 253
    privileged: true
    gw: 192.168.50.1
    ip: 192.168.50.22
    bridge: vmbr2
    disk: 'local-lvm:40'
    cores: 4
    memory: 3072
    nesting: 1
    keyctl: 1

lxc_mounts:
  - name: Endowment
    vmid: 250
    privileged: false
    gw: 192.168.50.1
    ip: 192.168.50.20
    bridge: vmbr2
    disk: 'local-lvm:75'
    cores: 8
    memory: 6144
    nesting: 1
    keyctl: 0
    fsmount: cifs

### Variables
install_nut: false
pull_backup: false
infrastructure: false
# mergerfs_ver: 2.32.4
# nag_ver: 0.0.7

### Telegraf
telegraf_influx_token: "{{secret_telegraf_adonalsium}}"
telegraf_influx_bucket: Adonalsium
telegraf_influx_disk_mounts: '"/","/mnt/Media"'
telegraf_influx_docker: true
telegraf_influx_pve: true
telegraf_influx_pve_api: "{{secret_telegraf_adonalsium_api}}"

### Cronjobs
cronjobs:
  - name: Scrutiny
    job: /usr/local/bin/runitor -uuid {{secret_hc_adonalsium_scrutiny}} -- docker exec scrutiny /scrutiny/bin/scrutiny-collector-metrics run > /dev/null 2>&1
    user: "{{ main_username }}"
    minute: 0
    hour: '*/6'
  - name: Restic Prune
    job: /usr/local/bin/runitor -uuid {{secret_hc_adonalsium_purge}} -- /usr/local/bin/autorestic forget -a -- prune
    user: "{{ main_username }}"
    minute: 0
    hour: 1
    weekday: 1
  - name: Restic Check
    job: /usr/local/bin/runitor -uuid {{secret_hc_restic_check_adonalsium}} -- /usr/local/bin/autorestic check
    user: "{{ main_username }}"
    minute: 30
    hour: 3
    day: 1
  - name: Media Backup (Docker)
    job: /usr/local/bin/runitor -uuid {{secret_hc_adonalsium_media_docker}} -- /usr/local/bin/autorestic backup -l docker -c /home/{{main_username}}/.autorestic.yml
    user: root
    minute: 45
    hour: 23
  - name: Media Backup (Everything Else)
    job: /usr/local/bin/runitor -uuid {{secret_hc_adonalsium_media_all}} -- /usr/local/bin/autorestic backup -l photos -l files -l music -l audiobooks -c /home/{{main_username}}/.autorestic.yml
    user: root
    minute: 15
    hour: 1
    weekday: 0,3,5

### Autorestic Config
autorestic_config_yaml:
  backends:
    synology_docker:
      type: s3
      path: 'http://192.168.30.25:9000/adonalsium'
      key: "{{ secret_restic_repo_password }}"
      env:
        - AWS_ACCESS_KEY_ID: "{{ secret_minio_s3_access_key_id }}"
        - AWS_SECRET_ACCESS_KEY: "{{ secret_minio_s3_access_key }}"
    synology_photos:
      type: s3
      path: 'http://192.168.30.25:9000/media/photos'
      key: "{{ secret_restic_repo_password }}"
      env:
        - AWS_ACCESS_KEY_ID: "{{ secret_minio_s3_access_key_id }}"
        - AWS_SECRET_ACCESS_KEY: "{{ secret_minio_s3_access_key }}"
    synology_music:
      type: s3
      path: 'http://192.168.30.25:9000/media/music'
      key: "{{ secret_restic_repo_password }}"
      env:
        - AWS_ACCESS_KEY_ID: "{{ secret_minio_s3_access_key_id }}"
        - AWS_SECRET_ACCESS_KEY: "{{ secret_minio_s3_access_key }}"
    synology_audiobooks:
      type: s3
      path: 'http://192.168.30.25:9000/media/audiobooks'
      key: "{{ secret_restic_repo_password }}"
      env:
        - AWS_ACCESS_KEY_ID: "{{ secret_minio_s3_access_key_id }}"
        - AWS_SECRET_ACCESS_KEY: "{{ secret_minio_s3_access_key }}"
    synology_files:
      type: s3
      path: 'http://192.168.30.25:9000/media/files'
      key: "{{ secret_restic_repo_password }}"
      env:
        - AWS_ACCESS_KEY_ID: "{{ secret_minio_s3_access_key_id }}"
        - AWS_SECRET_ACCESS_KEY: "{{ secret_minio_s3_access_key }}"
    b2_docker:
      type: b2
      path: "{{ secret_restic_b2_bucket }}:/adonalsium"
      key: "{{ secret_restic_repo_password }}"
      env:
        - B2_ACCOUNT_ID: "{{ secret_restic_b2_account_id }}"
        - B2_ACCOUNT_KEY: "{{ secret_restic_b2_account_key }}"
    b2_photos:
      type: b2
      path: "{{ secret_media_b2_bucket }}:/photos"
      key: "{{ secret_restic_repo_password }}"
      env:
        - B2_ACCOUNT_ID: "{{ secret_media_b2_account_id }}"
        - B2_ACCOUNT_KEY: "{{ secret_media_b2_account_key }}"
    b2_music:
      type: b2
      path: "{{ secret_media_b2_bucket }}:/music"
      key: "{{ secret_restic_repo_password }}"
      env:
        - B2_ACCOUNT_ID: "{{ secret_media_b2_account_id }}"
        - B2_ACCOUNT_KEY: "{{ secret_media_b2_account_key }}"
    b2_audiobooks:
      type: b2
      path: "{{ secret_media_b2_bucket }}:/audiobooks"
      key: "{{ secret_restic_repo_password }}"
      env:
        - B2_ACCOUNT_ID: "{{ secret_media_b2_account_id }}"
        - B2_ACCOUNT_KEY: "{{ secret_media_b2_account_key }}"
    b2_files:
      type: b2
      path: "{{ secret_media_b2_bucket }}:/files"
      key: "{{ secret_restic_repo_password }}"
      env:
        - B2_ACCOUNT_ID: "{{ secret_media_b2_account_id }}"
        - B2_ACCOUNT_KEY: "{{ secret_media_b2_account_key }}"
  locations:
    docker:
      from: '/home/{{main_username}}/docker'
      to:
        - synology_docker
        - b2_docker
      options:
        forget:
          keep-daily: 1
          keep-weekly: 8
          keep-monthly: 4
    photos:
      from: '/mnt/Media/Photos'
      to:
        - synology_photos
        - b2_photos
      options:
        forget:
          keep-daily: 1
          keep-weekly: 8
          keep-monthly: 4
    music:
      from: '/mnt/Media/Music'
      to:
        - synology_music
        - b2_music
      options:
        forget:
          keep-daily: 1
          keep-weekly: 8
          keep-monthly: 4
    audiobooks:
      from: '/mnt/Media/Audiobooks'
      to:
        - synology_audiobooks
        - b2_audiobooks
      options:
        forget:
          keep-daily: 1
          keep-weekly: 8
          keep-monthly: 4
    files:
      from: '/mnt/Media/Files'
      to:
        - synology_files
        - b2_files
      options:
        backup:
          exclude:
            - 'Takeout'
        forget:
          keep-daily: 1
          keep-weekly: 8
          keep-monthly: 4

### Snapraid Config
snapraid_force_install: false
snapraid_install: false
snapraid_runner: false
snapraid_bin_path: /usr/bin/snapraid
snapraid_runner_email_address_from: "{{ secret_snapraid_email_from }}"
snapraid_runner_email_address_to: "{{ secret_snapraid_email_to }}"
snapraid_runner_smtp_host: "{{ secret_snapraid_smtp_host }}"
snapraid_runner_smtp_port: 8025
snapraid_runner_use_ssl: false
snapraid_runner_touch: false
snapraid_runner_command: "python3 {{ snapraid_run_bin }} -c {{ snapraid_run_conf}}"
snapraid_runner_cron_jobs:
  - {job: '/usr/local/bin/runitor -uuid {{secret_hc_adonalsium_snapraid}} -- {{ snapraid_run_command }}', name: 'snapraid_runner', weekday: '*', hour: '04'}
snapraid_config_excludes:
  - "*.unrecoverable"
  - "/tmp/"
  - "/lost+found/"
  - "downloads/"
  - "appdata/"
  - "*.!sync"
  - ".AppleDouble"
  - "._AppleDouble"
  - ".DS_Store"
  - "._.DS_Store"
  - ".Thumbs.db"
  - ".fseventsd"
  - ".Spotlight-V100"
  - ".TemporaryItems"
  - ".AppleDB"
  - ".Trash*"

### Docker-Compose with ironicbadger.docker_compose_generator
appdata_path: "/home/{{ main_username }}/docker"
containers:
  ###
  - service_name: diun
    container_name: diun
    active: true
    image: crazymax/diun:4.20.1
    restart: always
    volumes:
      - "{{ appdata_path }}/diun/data:/data"
      - "{{ appdata_path }}/diun/config.yml:/diun.yml:ro"
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - LOG_LEVEL=info
      - LOG_JSON=false
    hostname: "{{ hostname }}"
    include_global_env_vars: true
  ###
  - service_name: remote-api
    container_name: remote-api
    active: true
    image: kekru/docker-remote-api-tls:v0.3.0
    restart: always
    ports:
      - 2376:443
    volumes:
      - "{{ appdata_path }}/docker-api:/data/certs"
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - CREATE_CERTS_WITH_PW={{ secret_docker_api_tls }}
      - CERT_HOSTNAME=docker-remote.local
    include_global_env_vars: false
  ###
  - service_name: portainer
    container_name: portainer
    active: true
    image: portainer/portainer-ce:2.9.1
    restart: always
    mem_limit: 200M
    ports:
      - 9000:9000
      - 8000:8000
    volumes:
      - /srv/docker/portainer:/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - AGENT_SECRET={{secret_portainer_key}}
    include_global_env_vars: false
  ###
  - service_name: scrutiny
    container_name: scrutiny
    active: true
    image: analogj/scrutiny:v0.3.12-omnibus
    restart: always
    privileged: true
    ports:
      - 8080:8080
    volumes:
      - "{{ appdata_path }}/scrutiny:/scrutiny/config"
      - /run/udev:/run/udev:ro
    devices:
      ### THIS IS LIKELY UNNCESSARY WITH THE PRIVILEGED FLAG
      # - /dev/sda:/dev/sda # SSD for later
      - /dev/sdb:/dev/sdb
      - /dev/sdc:/dev/sdc
      - /dev/sdd:/dev/sdd
      - /dev/sde:/dev/sde
      - /dev/sdf:/dev/sdf
      - /dev/sdg:/dev/sdg
      - /dev/sdh:/dev/sdh
      - /dev/nvme0n1:/dev/nvme
    cap_add:
      - SYS_RAWIO
      - SYS_ADMIN
    include_global_env_vars: false
  ###
  - service_name: handbrake
    container_name: handbrake
    active: true
    image: jlesage/handbrake:v1.24.2
    restart: always
    ports:
      - 5800:5800
    volumes:
      - "{{ appdata_path }}/handbrake/config:/config"
      - "{{ appdata_path }}/handbrake/storage:/storage"
      - "/mnt/Media//Movies/1-Processing/Handbrake/Watch:/watch"
      - "/mnt/Media/Movies/1-Processing/Handbrake/Output:/output"
    devices:
      - /dev/dri:/dev/dri
    environment:
      - TZ={{ ntp_timezone }}
    include_global_env_vars: false
